<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Sorex Search Demo</title>
		<style>
			* {
				box-sizing: border-box;
			}
			body {
				font-family:
					system-ui,
					-apple-system,
					sans-serif;
				max-width: 700px;
				margin: 2rem auto;
				padding: 0 1rem;
				background: #1a1a1a;
				color: #e0e0e0;
			}
			h1 {
				color: #fff;
				margin-bottom: 0.5rem;
			}
			.subtitle {
				color: #888;
				margin-bottom: 2rem;
			}
			input {
				width: 100%;
				padding: 0.75rem 1rem;
				font-size: 1rem;
				border: 1px solid #333;
				border-radius: 8px;
				background: #2a2a2a;
				color: #fff;
				outline: none;
			}
			input:focus {
				border-color: #4a9eff;
			}
			.results {
				margin-top: 1rem;
				min-height: 200px;
			}
			.result {
				display: flex;
				gap: 1rem;
				padding: 1rem;
				margin: 0.5rem 0;
				background: #2a2a2a;
				border-radius: 8px;
				border-left: 3px solid #4a9eff;
				text-decoration: none;
				color: inherit;
			}
			.result:hover {
				background: #333;
			}
			.result-matched-term {
				flex-shrink: 0;
				max-width: 100px;
				font-family: monospace;
				font-size: 0.85rem;
				color: #9d7cd8;
				padding-top: 2px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			.result-content {
				flex: 1;
				min-width: 0;
			}
			.result-header {
				display: flex;
				align-items: baseline;
				gap: 0.5rem;
				margin-bottom: 0.25rem;
			}
			.result-title {
				font-weight: 600;
				color: #fff;
			}
			.result-match-type {
				font-size: 0.75rem;
				padding: 2px 6px;
				border-radius: 4px;
				background: #3a3a3a;
				color: #888;
			}
			.result-match-type.title {
				background: #2d4a2d;
				color: #7cb97c;
			}
			.result-match-type.section {
				background: #4a3d2d;
				color: #c9a86c;
			}
			.result-match-type.content {
				background: #3a3a3a;
				color: #888;
			}
			.result-excerpt {
				color: #aaa;
				font-size: 0.9rem;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			.result-score {
				flex-shrink: 0;
				width: 50px;
				text-align: right;
				font-family: monospace;
				font-size: 0.85rem;
				color: #4a9eff;
				padding-top: 2px;
			}
			.loading {
				color: #888;
				padding: 1rem;
			}
			.error {
				color: #ff6b6b;
				padding: 1rem;
			}
			.stats {
				font-size: 0.85rem;
				color: #666;
				margin-top: 0.5rem;
			}
		</style>
	</head>
	<body>
		<h1>Sorex Search</h1>
		<p class="subtitle">Self-contained search from a single .sorex file</p>

		<input type="text" id="search" placeholder="Type to search..." disabled />
		<div class="stats" id="stats"></div>
		<div class="results" id="results">
			<div class="loading">Loading search index...</div>
		</div>

		<script type="module">
			const searchInput = document.getElementById('search');
			const resultsDiv = document.getElementById('results');
			const statsDiv = document.getElementById('stats');

			const MATCH_TYPES = ['title', 'section', 'section', 'section', 'content'];
			const MATCH_LABELS = ['Title', 'H2', 'H3', 'H4', 'Content'];

			let searcher = null;

			async function initSearch() {
				try {
					const { loadSorex } = await import('./sorex.js');
					searcher = await loadSorex('./index.sorex');

					searchInput.disabled = false;
					searchInput.focus();
					resultsDiv.innerHTML = '<div class="loading">Ready! Type to search.</div>';
					statsDiv.textContent = `${searcher.docCount()} docs, ${searcher.vocabSize()} terms`;
				} catch (err) {
					resultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
					console.error(err);
				}
			}

			function doSearch(query) {
				if (!searcher || !query.trim()) {
					resultsDiv.innerHTML = '<div class="loading">Type to search...</div>';
					return;
				}

				const start = performance.now();
				const results = searcher.searchSync(query, 10);
				const elapsed = (performance.now() - start).toFixed(1);

				if (results.length === 0) {
					resultsDiv.innerHTML = `<div class="loading">No results for "${escapeHtml(query)}"</div>`;
					return;
				}

				resultsDiv.innerHTML = results
					.map((r) => {
						const matchType = MATCH_TYPES[r.matchType] || 'content';
						const matchLabel = MATCH_LABELS[r.matchType] || 'Content';
						const scoreDisplay = r.score >= 1000 ? Math.round(r.score) : r.score.toFixed(1);
						const matchedTerm = r.matchedTerm || '';
						return `
          <a href="${r.href}${r.sectionId ? '#' + r.sectionId : ''}" class="result">
            <div class="result-matched-term" title="${escapeHtml(matchedTerm)}">${escapeHtml(matchedTerm)}</div>
            <div class="result-content">
              <div class="result-header">
                <span class="result-match-type ${matchType}">${matchLabel}</span>
                <span class="result-title">${escapeHtml(r.title)}</span>
              </div>
              <div class="result-excerpt">${escapeHtml(r.excerpt || '')}</div>
            </div>
            <div class="result-score">${scoreDisplay}</div>
          </a>
        `;
					})
					.join('');

				statsDiv.textContent = `${results.length} results in ${elapsed}ms`;
			}

			function escapeHtml(s) {
				return s.replace(
					/[&<>"']/g,
					(c) =>
						({
							'&': '&amp;',
							'<': '&lt;',
							'>': '&gt;',
							'"': '&quot;',
							"'": '&#39;'
						})[c]
				);
			}

			let timeout;
			searchInput.addEventListener('input', (e) => {
				clearTimeout(timeout);
				timeout = setTimeout(() => doSearch(e.target.value), 100);
			});

			initSearch();
		</script>
	</body>
</html>
