<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sorex Search Demo</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    h1 { color: #fff; margin-bottom: 0.5rem; }
    .subtitle { color: #888; margin-bottom: 2rem; }
    input {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1px solid #333;
      border-radius: 8px;
      background: #2a2a2a;
      color: #fff;
      outline: none;
    }
    input:focus { border-color: #4a9eff; }
    .results {
      margin-top: 1rem;
      min-height: 200px;
    }
    .result {
      padding: 1rem;
      margin: 0.5rem 0;
      background: #2a2a2a;
      border-radius: 8px;
      border-left: 3px solid #4a9eff;
    }
    .result-title {
      font-weight: 600;
      color: #fff;
      margin-bottom: 0.25rem;
    }
    .result-excerpt {
      color: #aaa;
      font-size: 0.9rem;
    }
    .result-meta {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
    }
    .loading { color: #888; padding: 1rem; }
    .error { color: #ff6b6b; padding: 1rem; }
    .stats {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>Sorex Search</h1>
  <p class="subtitle">Self-contained search from a single .sorex file</p>

  <input type="text" id="search" placeholder="Type to search..." disabled>
  <div class="stats" id="stats"></div>
  <div class="results" id="results">
    <div class="loading">Loading search index...</div>
  </div>

  <script type="module">
    // Self-contained loader - no external dependencies
    import { loadSorex } from './sorex-loader.js';

    const searchInput = document.getElementById('search');
    const resultsDiv = document.getElementById('results');
    const statsDiv = document.getElementById('stats');

    let searcher = null;

    async function initSearch() {
      try {
        // Load .sorex file (contains both WASM and index)
        searcher = await loadSorex('./{{INDEX_FILE}}');

        // Enable search
        searchInput.disabled = false;
        searchInput.focus();
        resultsDiv.innerHTML = '<div class="loading">Ready! Type to search.</div>';
        statsDiv.textContent = `${searcher.doc_count()} docs, ${searcher.vocab_size()} terms`;
      } catch (err) {
        resultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
        console.error(err);
      }
    }

    function doSearch(query) {
      if (!searcher || !query.trim()) {
        resultsDiv.innerHTML = '<div class="loading">Type to search...</div>';
        return;
      }

      const start = performance.now();
      const results = searcher.search(query, 10);
      const elapsed = (performance.now() - start).toFixed(1);

      if (results.length === 0) {
        resultsDiv.innerHTML = `<div class="loading">No results for "${query}"</div>`;
        return;
      }

      resultsDiv.innerHTML = results.map(r => `
        <a href="${r.href}${r.sectionId ? '#' + r.sectionId : ''}" class="result" style="display:block;text-decoration:none;color:inherit;">
          <div class="result-title">${escapeHtml(r.title)}</div>
          <div class="result-excerpt">${escapeHtml(r.excerpt || '')}</div>
        </a>
      `).join('');

      statsDiv.textContent = `${results.length} results in ${elapsed}ms`;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[c]);
    }

    // Debounced search
    let timeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => doSearch(e.target.value), 100);
    });

    initSearch();
  </script>
</body>
</html>
